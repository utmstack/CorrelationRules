- id: 1008
  dataTypes:
    - kibana
  name: Watcher UI Exploitation Attempt
  impact:
    confidentiality: 4
    integrity: 4
    availability: 3
  category: Privilege Escalation
  technique: Exploitation for Privilege Escalation
  adversary: origin
  references:
    - https://www.elastic.co/guide/en/kibana/current/watcher-ui.html
    - https://attack.mitre.org/techniques/T1068/
  description: Detects attempts to exploit Watcher UI vulnerabilities or bypass access controls. This includes unauthorized attempts to create, modify, or execute watches that could be used for persistence or data exfiltration.
  where: |
    safe(log.component, "") == "plugins.watcher" &&
    (safe(actionResult, "") == "failure" ||
     safe(log.severityLabel, "") == "error") &&
    (safe(log.action, "") =~ "watcher_.*" ||
     safe(log.actionMessage, "") =~ ".*watcher.*" ||
     safe(log.actionMessage, "") =~ ".*unauthorized.*" ||
     safe(log.actionMessage, "") =~ ".*permission.*denied.*")
  afterEvents:
    - indexPattern: v11-log-*
      with:
        - field: origin.user.keyword
          operator: filter_term
          value: '{{origin.user}}'
      within: now-10m
      count: 4
  deduplicateBy:
    - origin.user
    - log.action