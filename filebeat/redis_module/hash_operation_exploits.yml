- id: 1020
  dataTypes:
    - redis_module
  name: Redis Hash Operation Exploitation
  impact:
    confidentiality: 4
    integrity: 3
    availability: 2
  category: Credential Access
  technique: Credentials from Password Stores
  adversary: origin
  references:
    - https://redis.io/docs/latest/develop/data-types/hashes/
    - https://redis.io/docs/latest/commands/hset/
    - https://attack.mitre.org/techniques/T1555/
  description: Detects potential exploitation of Redis hash operations including attempts to access credential stores, mass extraction of hash fields with HGETALL, or suspicious patterns in HMSET operations that could indicate data injection attacks
  where: |
    safe(log.msg, "") != "" && 
    (
      (safe(log.msg, "").contains("HGETALL") && (safe(log.msg, "").contains("password") || safe(log.msg, "").contains("credential") || safe(log.msg, "").contains("token"))) ||
      (safe(log.msg, "").contains("HMSET") && safe(log.msg, "").matches(".*HMSET\\s+\\w+\\s+(.+\\s+){20,}.*")) ||
      (safe(log.msg, "").contains("HSCAN") && safe(log.msg, "").contains("MATCH") && safe(log.msg, "").contains("*")) ||
      (safe(log.msg, "").contains("HKEYS") && safe(log.severity, "") == "warning") ||
      (safe(log.msg, "").contains("HDEL") && safe(log.msg, "").matches(".*HDEL\\s+\\w+\\s+(.+\\s+){10,}.*")) ||
      (safe(log.msg, "").contains("hash") && safe(log.msg, "").contains("injection"))
    ) &&
    safe(origin.host, "") != ""
  afterEvents:
    - indexPattern: v11-log-*
      with:
        - field: origin.host.keyword
          operator: filter_term
          value: '{{origin.host}}'
        - field: log.msg
          operator: filter_regex
          value: '.*(HGET|HSET|HMSET|HSCAN|HKEYS).*'
      within: now-10m
      count: 15
  deduplicateBy:
    - origin.host
    - log.msg