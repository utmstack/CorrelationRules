- id: 1022
  dataTypes:
    - osquery_module
  name: ATC Table Exploitation Attempt
  impact:
    confidentiality: 5
    integrity: 3
    availability: 1
  category: Credential Access
  technique: Credentials from Password Stores
  adversary: origin
  references:
    - https://www.kolide.com/blog/how-to-build-custom-osquery-tables-using-atc
    - https://attack.mitre.org/techniques/T1555/
  description: Detects potential exploitation of Auto Table Construction (ATC) feature to access sensitive SQLite databases. Monitors for queries targeting browser credentials, keychains, or other sensitive application databases that could expose PII or credentials.
  where: |
    safe(log.eventName, "") == "auto_table_construction" &&
    (safe(log.message, "").contains("password") ||
     safe(log.message, "").contains("keychain") ||
     safe(log.message, "").contains("login_data") ||
     safe(log.message, "").contains("cookies") ||
     safe(log.message, "").contains("history") ||
     safe(log.message, "").contains("chrome") ||
     safe(log.message, "").contains("firefox") ||
     safe(log.message, "").contains("safari") ||
     safe(origin.path, "").contains("Login Data") ||
     safe(origin.path, "").contains("Cookies") ||
     safe(origin.path, "").contains("History") ||
     safe(origin.path, "").contains("keychain"))
  afterEvents:
    - indexPattern: v11-log-*
      with:
        - field: origin.host.keyword
          operator: filter_term
          value: '{{origin.host}}'
        - field: log.eventName.keyword
          operator: filter_term
          value: 'auto_table_construction'
      within: now-1h
      count: 3
  deduplicateBy:
    - origin.host
    - origin.user