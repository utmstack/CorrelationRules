- id: 1021
  dataTypes:
    - nginx
  name: DNS Resolution Attack Detected
  impact:
    confidentiality: 1
    integrity: 2
    availability: 4
  category: Network Security
  technique: DNS Hijacking
  adversary: origin
  references:
    - https://blog.nginx.org/blog/dynamic-dns-resolution-open-sourced-in-nginx
    - https://attack.mitre.org/techniques/T1584/002/
  description: Detects potential DNS resolution attacks targeting nginx upstream servers. This rule identifies error patterns related to DNS resolution failures, excessive DNS queries, or suspicious domain resolutions that may indicate DNS hijacking, poisoning, or DoS attacks against the DNS infrastructure.
  where: |
    safe(log.severityLabel, "") == "error" && 
    safe(log.message, "") != "" && 
    (
      log.message.contains("no resolver defined") ||
      log.message.contains("could not be resolved") ||
      log.message.contains("host not found in upstream") ||
      log.message.contains("upstream timed out") ||
      log.message.contains("no live upstreams") ||
      log.message.contains("upstream server temporarily disabled")
    ) &&
    safe(origin.ip, "") != ""
  afterEvents:
    - indexPattern: v11-log-*
      with:
        - field: origin.ip.keyword
          operator: filter_term
          value: '{{origin.ip}}'
        - field: log.severityLabel.keyword
          operator: filter_term
          value: error
      within: now-5m
      count: 10
  deduplicateBy:
    - origin.ip
    - target.ip