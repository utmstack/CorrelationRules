- id: 1009
  dataTypes:
    - nginx
  name: Nginx FastCGI Exploitation Attempt
  impact:
    confidentiality: 5
    integrity: 5
    availability: 3
  category: Initial Access
  technique: Exploit Public-Facing Application
  adversary: origin
  references:
    - https://nextcloud.com/blog/urgent-security-issue-in-nginx-php-fpm/
    - https://attack.mitre.org/techniques/T1190/
  description: Detects FastCGI exploitation attempts including path traversal, SCRIPT_FILENAME injection, and CVE-2019-11043 PHP-FPM/nginx RCE patterns
  where: |
    (safe(origin.path, "") contains ".php" && safe(origin.path, "") matches ".*(\\.\\.[\\/\\\\]|%2e%2e).*") ||
    (safe(log.request, "") contains "SCRIPT_FILENAME" && safe(log.request, "") contains "../") ||
    (safe(origin.path, "") matches ".*\\.php[\\/\\\\].*\\.php.*") ||
    (safe(log.message, "") contains "FastCGI sent in stderr" && safe(log.severityLabel, "") == "error") ||
    (safe(origin.path, "") contains ".php" && safe(origin.path, "") contains "%00") ||
    (safe(log.request, "") matches ".*\\.php.*[\\/\\\\]?.*\\?.*=.*\\.php.*") ||
    (safe(statusCode, 0) == 502 && safe(log.message, "") contains "fastcgi")
  afterEvents:
    - indexPattern: v11-log-*
      with:
        - field: origin.ip.keyword
          operator: filter_term
          value: '{{origin.ip}}'
        - field: origin.path.keyword
          operator: filter_wildcard
          value: '*.php*'
      within: now-5m
      count: 10
  deduplicateBy:
    - origin.ip
    - origin.path