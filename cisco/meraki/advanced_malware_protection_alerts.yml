- id: 1006
  dataTypes:
    - meraki
  name: Meraki Advanced Malware Protection Alert
  impact:
    confidentiality: 5
    integrity: 5
    availability: 3
  category: Malware
  technique: T1204.002
  adversary: origin
  references:
    - https://documentation.meraki.com/MX/Content_Filtering_and_Threat_Protection/Advanced_Malware_Protection_(AMP)
    - https://attack.mitre.org/techniques/T1204/002/
  description: Detects when Meraki Advanced Malware Protection (AMP) identifies malicious files being downloaded or executed on the network. This includes retrospective alerts where files previously considered safe are later identified as malicious.
  where: |
    safe(log.eventType, "") == "security_event" && 
    (safe(log.message, "") contains "malware" || safe(log.message, "") contains "AMP" || safe(log.message, "") contains "malicious") &&
    safe(origin.ip, "") != ""
  afterEvents:
    - indexPattern: v11-log-*
      with:
        - field: origin.ip.keyword
          operator: filter_term
          value: '{{origin.ip}}'
      within: now-1h
      count: 3
  deduplicateBy:
    - origin.ip
    - log.fileName